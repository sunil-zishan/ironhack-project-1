- name: Include common host injection
  import_role:
    name: common
    tasks_from: inject_hosts.yml

- name: Wait for Redis from vote host
  ansible.builtin.wait_for:
    host: "{{ redis_ip }}"
    port: 6379
    timeout: 30
  delegate_to: "{{ inventory_hostname }}"
  register: redis_ready

- name: Pull Vote Image
  community.docker.docker_image:
    name: sunilzishan/vote
    source: pull
    tag: latest
  when: redis_ready.succeeded and postgres_ready.succeeded

- name: Run Vote Container
  community.docker.docker_container:
    name: vote
    image: sunilzishan/vote:latest
    ports:
      - "8081:80"
    env:
      REDIS_HOST: "{{ hostvars['worker-redis']['ansible_host'] }}"
      REDIS_PORT: 6379
    state: started
    restart_policy: always
  when: redis_ready.succeeded and postgres_ready.succeeded

- name: Log failure if dependencies are not ready
  ansible.builtin.debug:
    msg: "Vote container not started because Redis or Postgres is not ready."
  when: redis_ready.failed or postgres_ready.failed
