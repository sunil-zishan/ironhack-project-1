- name: Inject Redis and Postgres into /etc/hosts
  ansible.builtin.lineinfile:
    path: /etc/hosts
    line: "{{ item }}"
    state: present
  loop:
    - "{{ hostvars['redis']['ansible_host'] | default('redis') }} redis"
    - "{{ hostvars['postgres']['ansible_host'] | default('postgres') }} postgres"
  become: true

- name: Wait for Redis from result host
  ansible.builtin.wait_for:
    host: redis
    port: 6379
    timeout: 30
  delegate_to: "{{ inventory_hostname }}"
  register: redis_ready

- name: Wait for Postgres from result host
  ansible.builtin.wait_for:
    host: postgres
    port: 5432
    timeout: 60
  delegate_to: "{{ inventory_hostname }}"
  register: postgres_ready

- name: Pull Result Image
  community.docker.docker_image:
    name: sunilzishan/result
    source: pull
    tag: latest
  when: redis_ready.succeeded and postgres_ready.succeeded

- name: Run Result Container
  community.docker.docker_container:
    name: result
    image: sunilzishan/result:latest
    ports:
      - "8082:80"
    env:
      PORT: "80"
      PG_HOST: postgres
      PG_PORT: "5432"
      PG_USER: postgres
      PG_PASSWORD: postgres
      PG_DATABASE: postgres
    state: started
    restart_policy: always
  when: redis_ready.succeeded and postgres_ready.succeeded

- name: Log failure if dependencies are not ready
  ansible.builtin.debug:
    msg: "Result container not started because Redis or Postgres is not ready."
  when: redis_ready.failed or postgres_ready.failed
